<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FACE ANALYTICS ULTIMATE | Medical Grade</title>
    <style>
        :root {
            --bg-deep: #050505;
            --panel-bg: rgba(20, 20, 20, 0.7);
            --border: 1px solid rgba(255, 255, 255, 0.1);
            --accent: #00f3ff; /* Surgical Cyan */
            --active-red: #ff2a2a; /* Active Dot Color */
            --text-main: #ececec;
            --text-muted: #888;
            --gold: #ffd700;
            --green: #00ff9d;
            --font-tech: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'Courier New', Courier, monospace;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-tech);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        header {
            width: 100%;
            padding: 15px 20px;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid #333;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .brand { font-family: var(--font-mono); font-weight: 700; letter-spacing: 2px; color: var(--accent); }
        .version { font-size: 0.7rem; color: #555; border: 1px solid #333; padding: 2px 6px; border-radius: 4px; }

        /* --- MAIN LAYOUT --- */
        main {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            width: 100%;
            max-width: 1400px;
            padding: 20px;
            flex: 1;
        }

        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; }
        }

        /* --- LEFT PANEL (CONTROLS) --- */
        .panel {
            background: var(--panel-bg);
            border: var(--border);
            border-radius: 12px;
            padding: 20px;
            height: fit-content;
            backdrop-filter: blur(20px);
        }

        .control-section { margin-bottom: 25px; }
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; letter-spacing: 1px; }

        /* Toggle Buttons */
        .toggle-group {
            display: flex;
            background: #000;
            border-radius: 6px;
            padding: 4px;
            border: 1px solid #333;
        }
        .toggle-btn {
            flex: 1;
            background: transparent;
            color: #666;
            border: none;
            padding: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            font-weight: 600;
        }
        .toggle-btn.active { background: #222; color: var(--accent); box-shadow: 0 0 10px rgba(0, 243, 255, 0.1); }

        /* Upload Button */
        .upload-btn {
            width: 100%;
            background: linear-gradient(45deg, #111, #222);
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: 0.3s;
            margin-bottom: 10px;
            display: block;
        }
        .upload-btn:hover { border-color: var(--accent); color: var(--accent); }
        input[type="file"] { display: none; }

        /* REFERENCE DIAGRAM (SVG) */
        .ref-container {
            width: 100%;
            aspect-ratio: 1/1;
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #face-svg { width: 80%; height: 80%; opacity: 0.5; transition: opacity 0.3s; }
        .highlight-zone { fill: transparent; stroke: none; transition: fill 0.2s; }
        .active-zone { fill: var(--active-red); opacity: 0.6; filter: drop-shadow(0 0 5px var(--active-red)); }

        /* GUIDE TEXT */
        .guide-box {
            margin-top: 15px;
            border-left: 3px solid var(--accent);
            padding-left: 15px;
        }
        #step-title { font-size: 0.8rem; color: var(--accent); margin-bottom: 4px; }
        #step-desc { font-size: 1rem; font-weight: bold; }

        /* --- RIGHT PANEL (CANVAS) --- */
        .workspace {
            position: relative;
            width: 100%;
            background: #080808;
            border: 1px solid #222;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            min-height: 500px;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        }

        canvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: none; /* Hide default cursor for lens */
        }

        /* LENS */
        #lens-canvas {
            position: absolute;
            pointer-events: none;
            border: 2px solid var(--active-red);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: none;
            z-index: 100;
            background: #000;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            color: #444;
        }

        /* --- RESULTS OVERLAY --- */
        #results-modal {
            display: none;
            width: 100%;
            animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: rgba(30,30,30,0.6);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .metric-label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-val { font-size: 1.2rem; font-weight: 700; color: #fff; font-family: var(--font-mono); }
        .tier-tag { 
            font-size: 0.75rem; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-weight: 800; 
            text-transform: uppercase;
        }
        .tier-s { background: var(--gold); color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .tier-a { background: var(--green); color: #000; }
        .tier-b { background: #444; color: #ccc; }
        .tier-f { background: var(--red); color: #fff; }

        @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        /* Floating Undo (Mobile) */
        .fab-undo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #222;
            color: var(--active-red);
            border: 1px solid var(--active-red);
            padding: 10px 15px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>

<header>
    <div class="brand">// FACE IQ <span style="color:#fff">PRO</span></div>
    <div class="version">v3.0.1</div>
</header>

<main>
    <div class="panel">
        
        <div class="control-section">
            <div class="section-title">Analysis Mode</div>
            <div class="toggle-group">
                <button class="toggle-btn active" id="mode-front" onclick="setMode('front')">FRONT</button>
                <button class="toggle-btn" id="mode-side" onclick="setMode('side')">SIDE</button>
            </div>
            <div style="height:10px"></div>
            <div class="toggle-group">
                <button class="toggle-btn active" id="gender-male" onclick="setGender('male')">MALE</button>
                <button class="toggle-btn" id="gender-female" onclick="setGender('female')">FEMALE</button>
            </div>
        </div>

        <div class="control-section">
            <label class="upload-btn">
                UPLOAD IMAGE
                <input type="file" id="fileIn" accept="image/png, image/jpeg, image/webp">
            </label>
        </div>

        <div class="control-section" id="ref-section" style="display:none;">
            <div class="section-title">Reference Map</div>
            <div class="ref-container">
                <svg id="face-svg" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20,40 Q20,10 50,10 Q80,10 80,40 Q80,90 50,110 Q20,90 20,40" fill="none" stroke="#444" stroke-width="1"/>
                    
                    <path id="zone-eye-l" class="highlight-zone" d="M28,45 Q35,40 42,45 Q35,50 28,45" />
                    <circle id="zone-pupil-l" class="highlight-zone" cx="35" cy="45" r="3" />
                    <path id="zone-eye-r" class="highlight-zone" d="M58,45 Q65,40 72,45 Q65,50 58,45" />
                    <circle id="zone-pupil-r" class="highlight-zone" cx="65" cy="45" r="3" />

                    <path id="zone-brow-l" class="highlight-zone" d="M25,38 Q35,32 45,38" stroke-width="2"/>
                    <path id="zone-brow-r" class="highlight-zone" d="M55,38 Q65,32 75,38" stroke-width="2"/>

                    <path id="zone-nose" class="highlight-zone" d="M50,45 L45,70 L55,70 Z" />
                    
                    <path id="zone-mouth" class="highlight-zone" d="M35,85 Q50,90 65,85 Q50,95 35,85" />
                    
                    <circle id="zone-chin" class="highlight-zone" cx="50" cy="110" r="5" />
                    <circle id="zone-jaw-l" class="highlight-zone" cx="22" cy="80" r="4" />
                    <circle id="zone-jaw-r" class="highlight-zone" cx="78" cy="80" r="4" />

                    <circle id="zone-ear" class="highlight-zone" cx="10" cy="60" r="5" style="display:none"/>
                </svg>
            </div>
            
            <div class="guide-box">
                <div id="step-title">STEP 1 / 20</div>
                <div id="step-desc">Upload an image to start</div>
            </div>
        </div>

    </div>

    <div class="workspace" id="workspace">
        <div class="empty-state" id="empty-msg">
            <h2 style="color:#333; margin-bottom:10px;">NO IMAGE</h2>
            <p style="font-size:0.8rem;">Upload a clear photo to enable the analysis engine.</p>
        </div>
        <canvas id="cvs"></canvas>
        <canvas id="lens-canvas" width="200" height="200"></canvas>
        
        <button class="fab-undo" onclick="undo()" id="undo-btn" style="display:none;">↩ UNDO</button>
    </div>

    <div id="results-modal">
        <h2 style="border-bottom:1px solid #333; padding-bottom:10px; margin-top:0;">ANALYSIS COMPLETE</h2>
        <div class="score-grid" id="metrics-grid"></div>
    </div>

</main>

<script>
    /** --- SYSTEM CONFIG --- **/
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const lensCvs = document.getElementById('lens-canvas');
    const lensCtx = lensCvs.getContext('2d');
    
    let img = new Image();
    let pts = []; 
    let mode = 'front';
    let gender = 'male';
    let scale = 1;

    // --- LANDMARK DEFINITIONS (THE MAP) ---
    // Zone IDs map to the SVG elements for highlighting
    const STEPS = {
        front: [
            { id: 'pupil_l', txt: "Left Pupil Center", zone: 'zone-pupil-l' },
            { id: 'pupil_r', txt: "Right Pupil Center", zone: 'zone-pupil-r' },
            { id: 'zygo_l', txt: "Left Cheekbone (Widest)", zone: 'zone-ear' }, // Approx
            { id: 'zygo_r', txt: "Right Cheekbone (Widest)", zone: 'zone-ear' },
            { id: 'in_canth_l', txt: "Left Inner Eye Corner", zone: 'zone-eye-l' },
            { id: 'out_canth_l', txt: "Left Outer Eye Corner", zone: 'zone-eye-l' },
            { id: 'in_canth_r', txt: "Right Inner Eye Corner", zone: 'zone-eye-r' },
            { id: 'out_canth_r', txt: "Right Outer Eye Corner", zone: 'zone-eye-r' },
            { id: 'brow_in_l', txt: "Left Brow Start (Inner)", zone: 'zone-brow-l' },
            { id: 'brow_out_l', txt: "Left Brow End (Outer)", zone: 'zone-brow-l' },
            { id: 'brow_in_r', txt: "Right Brow Start (Inner)", zone: 'zone-brow-r' },
            { id: 'brow_out_r', txt: "Right Brow End (Outer)", zone: 'zone-brow-r' },
            { id: 'nose_al_l', txt: "Left Nostril Edge", zone: 'zone-nose' },
            { id: 'nose_al_r', txt: "Right Nostril Edge", zone: 'zone-nose' },
            { id: 'lip_corn_l', txt: "Left Mouth Corner", zone: 'zone-mouth' },
            { id: 'lip_corn_r', txt: "Right Mouth Corner", zone: 'zone-mouth' },
            { id: 'hairline', txt: "Hairline Center", zone: '' },
            { id: 'glabella', txt: "Between Brows (Glabella)", zone: 'zone-brow-l' },
            { id: 'subnasale', txt: "Nose Base (Subnasale)", zone: 'zone-nose' },
            { id: 'menton', txt: "Chin Bottom (Menton)", zone: 'zone-chin' },
            { id: 'jaw_l', txt: "Left Jaw Angle", zone: 'zone-jaw-l' },
            { id: 'jaw_r', txt: "Right Jaw Angle", zone: 'zone-jaw-r' }
        ],
        side: [
            { id: 'glabella', txt: "Brow Ridge", zone: 'zone-brow-l' },
            { id: 'nasion', txt: "Nose Bridge Dip", zone: 'zone-nose' },
            { id: 'tip', txt: "Nose Tip", zone: 'zone-nose' },
            { id: 'subnasale', txt: "Nose Base", zone: 'zone-nose' },
            { id: 'pogonion', txt: "Chin Tip (Forward)", zone: 'zone-chin' },
            { id: 'menton', txt: "Chin Bottom (Down)", zone: 'zone-chin' },
            { id: 'gonion', txt: "Jaw Corner", zone: 'zone-jaw-l' },
            { id: 'tragion', txt: "Ear Hole (Tragus)", zone: 'zone-ear' }
        ]
    };

    /** --- INIT & EVENTS --- **/
    document.getElementById('fileIn').addEventListener('change', e => {
        if(!e.target.files[0]) return;
        img.src = URL.createObjectURL(e.target.files[0]);
        img.onload = () => {
            document.getElementById('empty-msg').style.display = 'none';
            document.getElementById('ref-section').style.display = 'block';
            document.getElementById('undo-btn').style.display = 'block';
            pts = [];
            resize();
            updateUI();
        };
    });

    window.addEventListener('resize', () => { resize(); draw(); });

    function setMode(m) {
        mode = m; pts = [];
        document.getElementById('mode-front').className = m === 'front' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('mode-side').className = m === 'side' ? 'toggle-btn active' : 'toggle-btn';
        updateUI(); draw();
    }

    function setGender(g) {
        gender = g;
        document.getElementById('gender-male').className = g === 'male' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('gender-female').className = g === 'female' ? 'toggle-btn active' : 'toggle-btn';
        if(pts.length === STEPS[mode].length) calculate();
    }

    function undo() { pts.pop(); updateUI(); draw(); }

    function resize() {
        if(!img.src) return;
        const ws = document.getElementById('workspace');
        // Fit image into workspace
        const ratio = img.width / img.height;
        let w = ws.clientWidth;
        let h = w / ratio;
        
        if (h > window.innerHeight * 0.7) {
            h = window.innerHeight * 0.7;
            w = h * ratio;
        }

        cvs.width = w;
        cvs.height = h;
        scale = w / img.width;
        draw();
    }

    /* --- INTERACTION ENGINE (ZERO LAG) --- */
    function handleInput(e, isClick) {
        if(!img.src || pts.length >= STEPS[mode].length) {
            lensCvs.style.display = 'none';
            return;
        }

        const rect = cvs.getBoundingClientRect();
        // Support Touch and Mouse
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        // Verify inside bounds
        if(x < 0 || y < 0 || x > cvs.width || y > cvs.height) {
            lensCvs.style.display = 'none';
            return;
        }

        if(isClick) {
            pts.push({x, y});
            updateUI();
            draw();
            if(pts.length === STEPS[mode].length) {
                lensCvs.style.display = 'none';
                calculate();
            }
        } else {
            // RENDER LENS (Performance Critical)
            lensCvs.style.display = 'block';
            lensCvs.style.left = (x - 100) + 'px'; // Center lens
            lensCvs.style.top = (y - 120) + 'px'; // Offset above finger

            // Source coordinates (on the original image)
            const srcX = x / scale;
            const srcY = y / scale;
            
            // Draw zoomed view directly from image to lens canvas
            const zoom = 3;
            const lensW = lensCvs.width; // 200
            const lensH = lensCvs.height; // 200
            
            // Clear lens
            lensCtx.fillStyle = '#000';
            lensCtx.fillRect(0,0,lensW, lensH);
            
            // Draw image slice
            // We want to show a 200/3 = 66px area from source
            const srcW = lensW / zoom;
            const srcH = lensH / zoom;
            
            lensCtx.drawImage(img, srcX - srcW/2, srcY - srcH/2, srcW, srcH, 0, 0, lensW, lensH);

            // Draw Crosshair
            lensCtx.strokeStyle = 'rgba(255, 42, 42, 0.8)';
            lensCtx.lineWidth = 2;
            lensCtx.beginPath();
            lensCtx.moveTo(lensW/2 - 10, lensH/2); lensCtx.lineTo(lensW/2 + 10, lensH/2);
            lensCtx.moveTo(lensW/2, lensH/2 - 10); lensCtx.lineTo(lensW/2, lensH/2 + 10);
            lensCtx.stroke();
            
            // Draw Circular Border
            lensCtx.strokeStyle = '#00f3ff';
            lensCtx.lineWidth = 4;
            lensCtx.beginPath();
            lensCtx.arc(lensW/2, lensH/2, lensW/2 - 2, 0, Math.PI*2);
            lensCtx.stroke();
        }
    }

    // Event Listeners
    cvs.addEventListener('mousemove', e => handleInput(e, false));
    cvs.addEventListener('mousedown', e => handleInput(e, true));
    
    // Touch support (Prevent Scroll)
    cvs.addEventListener('touchmove', e => { e.preventDefault(); handleInput(e, false); }, {passive:false});
    cvs.addEventListener('touchstart', e => { e.preventDefault(); handleInput(e, false); }, {passive:false});
    cvs.addEventListener('touchend', e => {
        // Use last known pos from lens logic is safer, but simplistic approach:
        // We assume tap on spot.
        const t = e.changedTouches[0];
        const rect = cvs.getBoundingClientRect();
        handleInput({clientX: t.clientX, clientY: t.clientY}, true);
    });

    /* --- RENDERING & UI UPDATES --- */
    function updateUI() {
        const stepIdx = pts.length;
        const total = STEPS[mode].length;
        const guideTitle = document.getElementById('step-title');
        const guideDesc = document.getElementById('step-desc');
        const results = document.getElementById('results-modal');

        if(stepIdx < total) {
            const step = STEPS[mode][stepIdx];
            guideTitle.innerText = `STEP ${stepIdx + 1} / ${total}`;
            guideDesc.innerHTML = `Click: <span style="color:var(--accent)">${step.txt}</span>`;
            results.style.display = 'none';
            highlightZone(step.zone);
        } else {
            guideTitle.innerText = "COMPLETE";
            guideDesc.innerHTML = "<span style='color:var(--gold)'>Generating Report...</span>";
            highlightZone(null);
        }
    }

    function highlightZone(zoneId) {
        // Reset all
        document.querySelectorAll('.active-zone').forEach(el => el.classList.remove('active-zone'));
        if(zoneId) {
            const el = document.getElementById(zoneId);
            if(el) el.classList.add('active-zone');
        }
    }

    function draw() {
        ctx.clearRect(0,0,cvs.width, cvs.height);
        if(img.src) ctx.drawImage(img, 0, 0, cvs.width, cvs.height);

        // Draw connections if done
        if(pts.length === STEPS[mode].length) {
            ctx.lineWidth = 1;
            ctx.strokeStyle = "rgba(0, 243, 255, 0.4)";
            ctx.beginPath();
            if(mode === 'front') {
                // Jawline
                connect(20, 19); connect(19, 21);
                // Eyes
                connect(4, 5); connect(6, 7);
                // Brows
                connect(8, 9); connect(10, 11);
            } else {
                connect(0, 1); connect(1, 2); connect(2, 3); connect(3, 4);
            }
            ctx.stroke();
        }

        // Draw Points
        pts.forEach((p, i) => {
            ctx.beginPath();
            ctx.fillStyle = (i === pts.length - 1) ? 'var(--active-red)' : 'var(--accent)';
            ctx.arc(p.x, p.y, 2.5, 0, Math.PI*2);
            ctx.fill();
        });
    }
    
    function connect(i1, i2) {
        ctx.moveTo(pts[i1].x, pts[i1].y);
        ctx.lineTo(pts[i2].x, pts[i2].y);
    }

    /* --- MATH CORE --- */
    function dist(i1, i2) {
        return Math.sqrt(Math.pow(pts[i1].x - pts[i2].x, 2) + Math.pow(pts[i1].y - pts[i2].y, 2));
    }

    function angle(i1, i2, i3) {
        // Vertex at i2
        const A = pts[i1], B = pts[i2], C = pts[i3];
        const AB = Math.sqrt(Math.pow(B.x-A.x, 2) + Math.pow(B.y-A.y, 2));
        const BC = Math.sqrt(Math.pow(B.x-C.x, 2) + Math.pow(B.y-C.y, 2));
        const AC = Math.sqrt(Math.pow(C.x-A.x, 2) + Math.pow(C.y-A.y, 2));
        return Math.acos((AB*AB + BC*BC - AC*AC) / (2*AB*BC)) * (180/Math.PI);
    }

    function tilt(i1, i2) {
        // Angle relative to horizon. Invert Y because canvas Y is down.
        // Positive = Outer(i2) is higher(smaller Y) than Inner(i1)
        const dy = pts[i1].y - pts[i2].y;
        const dx = Math.abs(pts[i2].x - pts[i1].x);
        return Math.atan2(dy, dx) * (180/Math.PI);
    }

    function getTier(val, ranges, scores) {
        for(let i=0; i<ranges.length; i++) {
            if(val >= ranges[i][0] && val <= ranges[i][1]) {
                return { 
                    label: `Tier ${i+1}`, 
                    cls: i===0?'tier-s':(i===1?'tier-a':'tier-b'),
                    score: scores[i] || 0
                };
            }
        }
        return { label: 'Fail', cls: 'tier-f', score: scores[scores.length-1] || -5 };
    }

    function calculate() {
        const grid = document.getElementById('metrics-grid');
        grid.innerHTML = "";
        let html = "";

        const add = (label, val, tier) => {
            html += `
            <div class="metric-card">
                <div>
                    <div class="metric-label">${label}</div>
                    <div class="metric-val">${val}</div>
                </div>
                <div class="tier-tag ${tier.cls}">${tier.label}</div>
            </div>`;
        };

        if(mode === 'front') {
            // 1. ESR (Pupil Dist / Zygo)
            const esr = (dist(0,1) / dist(2,3)) * 100;
            const r_esr = gender === 'male' ? [[44.3,47.7], [43.6,48.4]] : [[45,47.9], [44.3,48.6]];
            add("Eye Spacing", esr.toFixed(1)+"%", getTier(esr, r_esr, [35, 17.5]));

            // 2. Canthal Tilt (Avg)
            const t = (tilt(4,5) + tilt(6,7)) / 2;
            const r_tilt = gender === 'male' ? [[5.2,8.5], [4,9.7]] : [[6,9.6], [4.8,10.8]];
            add("Canthal Tilt", t.toFixed(1)+"°", getTier(t, r_tilt, [25, 12.5]));

            // 3. Mouth-to-Nose Width (Mouth / Nose)
            const mn = dist(14,15) / dist(12,13);
            const r_mn = gender === 'male' ? [[1.38,1.53], [1.34,1.57]] : [[1.45,1.67], [1.4,1.72]];
            add("Mouth-Nose Ratio", mn.toFixed(2), getTier(mn, r_mn, [10, 5]));

            // 4. Eyebrow Tilt (Avg)
            const bt = (tilt(8,9) + tilt(10,11)) / 2;
            const r_bt = gender === 'male' ? [[5,13], [3,15]] : [[11,18.7], [9,20.7]];
            add("Eyebrow Tilt", bt.toFixed(1)+"°", getTier(bt, r_bt, [6, 3]));

            // 5. Chin-Philtrum (ChinH / PhilH)
            const cpr = dist(19,13) / dist(18,12); // Approx using Lip Top as Philtrum bottom
            const r_cpr = gender === 'male' ? [[2.05,2.55]] : [[2.0,2.5]];
            add("Chin-Philtrum", cpr.toFixed(2), getTier(cpr, r_cpr, [12.5, 6]));

            // 6. Bigonial Width (Jaw / Zygo)
            const big = (dist(20,21) / dist(2,3)) * 100;
            const r_big = gender === 'male' ? [[85.5,92], [83.5,94]] : [[81.5,88.5], [79.5,90.5]];
            add("Jaw Width Ratio", big.toFixed(1)+"%", getTier(big, r_big, [15, 7.5]));
        } else {
            // SIDE
            // 1. Gonial Angle (Trag->Gon->Men)
            const ga = angle(7, 6, 5);
            const r_ga = gender === 'male' ? [[112,123], [109.5,125.5]] : [[114,125], [111,128]];
            add("Gonial Angle", ga.toFixed(1)+"°", getTier(ga, r_ga, [40, 20]));

            // 2. Nasofrontal (Glab->Nas->Tip)
            const nfa = angle(0, 1, 2);
            const r_nfa = gender === 'male' ? [[106,129]] : [[122,143]];
            add("Nasofrontal Angle", nfa.toFixed(1)+"°", getTier(nfa, r_nfa, [15, 7.5]));

            // 3. Nasal Projection (Nasion-Tip / Nasion-Menton)
            const npr = dist(1,2) / dist(1,5);
            const r_npr = gender === 'male' ? [[0.55,0.68]] : [[0.52,0.68]];
            add("Nasal Projection", npr.toFixed(2), getTier(npr, r_npr, [5, 2.5]));
        }

        grid.innerHTML = html;
        document.getElementById('results-modal').style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }
</script>
</body>
</html>
