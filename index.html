<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HARMONY ANALYTICS v3.0 (Fixed Logic)</title>
    <style>
        :root { --primary: #00ff9d; --bg: #111; --panel: #1a1a1a; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; }
        
        /* HEADER */
        h1 { color: var(--primary); text-transform: uppercase; margin: 10px 0; font-size: 1.2rem; border-bottom: 2px solid var(--primary); padding-bottom: 5px; }

        /* CONTROLS */
        .controls { background: var(--panel); padding: 15px; border-radius: 8px; width: 100%; max-width: 600px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; border: 1px solid #333; }
        button, label { background: #333; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; border: 1px solid #555; font-weight: bold; font-size: 0.9rem; }
        button:hover, label:hover { border-color: var(--primary); color: var(--primary); }
        input { display: none; }
        
        /* GUIDE BOX */
        #guide { background: #2a2a00; color: #ffd700; padding: 15px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; width: 100%; max-width: 600px; text-align: center; border: 1px solid #ffd700; }
        
        /* CANVAS */
        .canvas-wrap { position: relative; border: 2px solid #333; max-width: 100%; overflow: hidden; display: none; }
        canvas { display: block; max-width: 100%; }

        /* MAGNIFIER */
        #lens { position: absolute; width: 140px; height: 140px; border: 2px solid var(--primary); border-radius: 50%; pointer-events: none; display: none; background: #000; box-shadow: 0 0 15px rgba(0,255,157,0.5); z-index: 100; }
        #lens::after { content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: red; transform: translate(-50%, -50%); border-radius: 50%; }

        /* RESULTS */
        #report { width: 100%; max-width: 600px; display: none; margin-top: 20px; padding-bottom: 50px; }
        .card { background: var(--panel); border: 1px solid #333; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .val { font-size: 1.3rem; font-weight: bold; color: white; }
        .tag { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; color: black; }
        .s-tier { background: #ffd700; box-shadow: 0 0 8px #ffd700; }
        .a-tier { background: var(--primary); }
        .b-tier { background: #aaa; }
        .f-tier { background: #ff5555; color: white; }
    </style>
</head>
<body>

    <h1>Harmony Analytics v3.0</h1>

    <div class="controls">
        <label>ðŸ“‚ Upload Photo <input type="file" id="fileIn" accept="image/*"></label>
        <button onclick="setMode('front')" id="btnFront">Front</button>
        <button onclick="setMode('side')" id="btnSide">Side</button>
        <button onclick="undo()" style="color:#ff5555; border-color:#ff5555;">Undo</button>
    </div>

    <div id="guide">Upload a photo to begin</div>

    <div class="canvas-wrap" id="wrap">
        <canvas id="cvs"></canvas>
        <div id="lens"></div>
    </div>

    <div id="report"></div>

<script>
    // --- CONFIG ---
    const cvs = document.getElementById('cvs');
    const ctx = cvs.getContext('2d');
    const wrap = document.getElementById('wrap');
    const lens = document.getElementById('lens');
    const guide = document.getElementById('guide');
    let img = new Image();
    let pts = [];
    let mode = 'front';
    let scale = 1;

    // --- LANDMARK MAP (Order Matters) ---
    // Note: "Image Left" = The left side of the photo (usually subject's right)
    const MAP = {
        front: [
            { id: 'pupil_L', txt: "Left Pupil (Image Left)" },
            { id: 'inner_L', txt: "Left Eye Inner Corner" },
            { id: 'outer_L', txt: "Left Eye Outer Corner" },
            { id: 'pupil_R', txt: "Right Pupil (Image Right)" },
            { id: 'inner_R', txt: "Right Eye Inner Corner" },
            { id: 'outer_R', txt: "Right Eye Outer Corner" },
            { id: 'zygo_L', txt: "Left Cheekbone (Widest Point)" },
            { id: 'zygo_R', txt: "Right Cheekbone (Widest Point)" },
            { id: 'lip_mid', txt: "Center of Lips" },
            { id: 'chin', txt: "Bottom of Chin" }
        ],
        side: [
            { id: 'gla', txt: "Brow Ridge (Glabella)" },
            { id: 'nas', txt: "Nose Bridge Dip (Nasion)" },
            { id: 'tip', txt: "Nose Tip" },
            { id: 'pog', txt: "Chin Tip (Most Forward)" },
            { id: 'men', txt: "Chin Bottom" },
            { id: 'gon', txt: "Jaw Corner (Gonion)" },
            { id: 'tra', txt: "Ear Hole (Tragus)" }
        ]
    };

    // --- CORE FUNCTIONS ---
    document.getElementById('fileIn').onchange = e => {
        if(!e.target.files[0]) return;
        img.src = URL.createObjectURL(e.target.files[0]);
        img.onload = () => { pts=[]; draw(); wrap.style.display='block'; updateGuide(); };
    };

    function setMode(m) { mode=m; pts=[]; draw(); updateGuide(); document.getElementById('report').innerHTML=''; }
    function undo() { pts.pop(); draw(); updateGuide(); }

    function updateGuide() {
        const m = MAP[mode];
        if(pts.length < m.length) {
            guide.innerText = `Step ${pts.length+1}/${m.length}: Click ${m[pts.length].txt}`;
            guide.style.background = "#2a2a00";
        } else {
            guide.innerText = "âœ“ Analysis Complete - See Report Below";
            guide.style.background = "#003300";
            calc();
        }
    }

    // --- CANVAS DRAWING ---
    function draw() {
        // Resize logic
        const maxW = Math.min(window.innerWidth - 20, 800);
        const ratio = img.width / img.height;
        cvs.width = maxW;
        cvs.height = maxW / ratio;
        scale = cvs.width / img.width;

        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(img.src) ctx.drawImage(img,0,0,cvs.width,cvs.height);

        // Draw points
        pts.forEach((p,i) => {
            ctx.fillStyle = '#00ff9d'; ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.font="12px sans-serif"; ctx.fillText(i+1, p.x+8, p.y);
        });
    }

    // --- INPUT HANDLING ---
    cvs.addEventListener('mousemove', e => {
        if(pts.length >= MAP[mode].length) { lens.style.display='none'; return; }
        const r = cvs.getBoundingClientRect();
        const x = e.clientX - r.left;
        const y = e.clientY - r.top;
        
        lens.style.display = 'block';
        lens.style.left = (x-70)+'px'; lens.style.top = (y-70)+'px';
        
        // 2.5x Zoom
        const z = 2.5;
        lens.style.backgroundImage = `url(${cvs.toDataURL()})`;
        lens.style.backgroundSize = `${cvs.width*z}px ${cvs.height*z}px`;
        lens.style.backgroundPosition = `-${x*z - 70}px -${y*z - 70}px`;
    });

    cvs.addEventListener('mousedown', e => {
        if(pts.length >= MAP[mode].length) return;
        const r = cvs.getBoundingClientRect();
        pts.push({ x: e.clientX - r.left, y: e.clientY - r.top });
        draw(); updateGuide();
    });

    // --- MATH & LOGIC ---
    function dist(i1, i2) {
        const p1 = pts[i1], p2 = pts[i2];
        return Math.sqrt(Math.pow(p1.x-p2.x, 2) + Math.pow(p1.y-p2.y, 2));
    }

    function calc() {
        const rep = document.getElementById('report');
        rep.style.display = 'block';
        let html = '';

        if(mode === 'front') {
            // 1. CANTHAL TILT (Corrected)
            // We use Inner(1) and Outer(2) for Left Eye
            // Note: In canvas, Y increases downwards. 
            // Positive Tilt = Outer Y is SMALLER (Higher) than Inner Y.
            const pL_in = pts[1], pL_out = pts[2];
            const pR_in = pts[4], pR_out = pts[5];

            // Formula: Angle relative to horizontal
            // We negate the result because canvas Y is inverted
            const tiltL = -Math.atan2(pL_out.y - pL_in.y, pL_out.x - pL_in.x) * (180/Math.PI);
            const tiltR = -Math.atan2(pR_out.y - pR_in.y, pR_out.x - pR_in.x) * (180/Math.PI);
            // Since right eye goes Right-to-Left on x-axis if we map straight, let's just use absolute height diff logic to be safe
            // Safer logic: just measure rise/run magnitude
            
            // Re-calc using simple rise/run to avoid direction confusion
            // Left Eye: Outer should be higher (smaller y)
            const riseL = pL_in.y - pL_out.y; 
            const runL = Math.abs(pL_out.x - pL_in.x);
            const angL = Math.atan2(riseL, runL) * (180/Math.PI);

            // Right Eye: Outer should be higher (smaller y)
            const riseR = pR_in.y - pR_out.y; 
            const runR = Math.abs(pR_out.x - pR_in.x);
            const angR = Math.atan2(riseR, runR) * (180/Math.PI);

            const avgTilt = (angL + angR) / 2;
            
            let tClass = "b-tier", tTxt = "Neutral";
            if(avgTilt > 4) { tClass = "s-tier"; tTxt = "Hunter (+)"; }
            else if(avgTilt < 0) { tClass = "f-tier"; tTxt = "Negative"; }

            html += card("Canthal Tilt", avgTilt.toFixed(1)+"Â°", tClass, tTxt, "Ideal is 5Â° - 8Â°");

            // 2. EYE SPACING (ESR) - Fixed
            // Formula: Inter-Pupillary Dist / Bizygomatic Width
            const ipd = dist(0, 3); // Pupil L to Pupil R
            const faceW = dist(6, 7); // Zygo L to Zygo R
            const esr = (ipd / faceW) * 100;

            let eClass = "b-tier", eTxt = "Avg";
            if(esr >= 45 && esr <= 48) { eClass="s-tier"; eTxt="Ideal"; }
            else if(esr >= 41 && esr <= 50) { eClass="a-tier"; eTxt="Good"; }

            html += card("Eye Spacing (ESR)", esr.toFixed(1)+"%", eClass, eTxt, "Based on Pupil Distance (Ideal ~46%)");

            // 3. MIDFACE COMPACTNESS
            // Pupil Y (Avg) to Lip Center Y / Face Width
            const avgPupilY = (pts[0].y + pts[3].y) / 2;
            const lipY = pts[8].y;
            const midHeight = lipY - avgPupilY;
            const ratio = midHeight / faceW;

            let cClass = "a-tier", cTxt = "Normal";
            if(ratio < 0.4) { cClass="s-tier"; cTxt="Compact"; }
            if(ratio > 0.5) { cClass="b-tier"; cTxt="Long"; }

            html += card("Midface Ratio", ratio.toFixed(2), cClass, cTxt, "Pupil-to-Lip / Face Width (Lower is better)");

            // DRAW DEBUG LINES
            ctx.strokeStyle = "yellow"; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(pL_in.x, pL_in.y); ctx.lineTo(pL_out.x, pL_out.y); ctx.stroke(); // Eye lines
            ctx.beginPath(); ctx.moveTo(pR_in.x, pR_in.y); ctx.lineTo(pR_out.x, pR_out.y); ctx.stroke();
            ctx.strokeStyle = "blue";
            ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[3].x, pts[3].y); ctx.stroke(); // IPD
            ctx.strokeStyle = "red";
            ctx.beginPath(); ctx.moveTo(pts[6].x, pts[6].y); ctx.lineTo(pts[7].x, pts[7].y); ctx.stroke(); // Width
        } 
        else {
            // SIDE PROFILE
            // Gonial Angle: Tragus(6) -> Gonion(5) -> Menton(4)
            const pTra = pts[6], pGon = pts[5], pMen = pts[4];
            
            // Cosine rule
            const a = Math.sqrt(Math.pow(pTra.x-pGon.x,2) + Math.pow(pTra.y-pGon.y,2));
            const b = Math.sqrt(Math.pow(pGon.x-pMen.x,2) + Math.pow(pGon.y-pMen.y,2));
            const c = Math.sqrt(Math.pow(pTra.x-pMen.x,2) + Math.pow(pTra.y-pMen.y,2));
            const ang = Math.acos((a*a + b*b - c*c)/(2*a*b)) * (180/Math.PI);

            let gClass = "b-tier";
            if(ang >= 115 && ang <= 125) gClass="s-tier";
            
            html += card("Gonial Angle", ang.toFixed(1)+"Â°", gClass, (ang>125?"Obtuse":"Ideal"), "Ideal: 118-123Â°");
            
            // Draw Lines
            ctx.strokeStyle = "lime"; ctx.lineWidth=3;
            ctx.beginPath(); ctx.moveTo(pTra.x, pTra.y); ctx.lineTo(pGon.x, pGon.y); ctx.lineTo(pMen.x, pMen.y); ctx.stroke();
        }

        rep.innerHTML = html;
        window.scrollTo(0, document.body.scrollHeight);
    }

    function card(title, val, cls, tag, desc) {
        return `<div class="card">
            <div>
                <div style="color:#888; font-size:0.8rem">${title}</div>
                <div class="val">${val}</div>
                <div style="font-size:0.75rem; opacity:0.7">${desc}</div>
            </div>
            <div class="tag ${cls}">${tag}</div>
        </div>`;
    }
</script>
</body>
</html>
